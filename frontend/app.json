let sessionId = null;

function resetUI() {
    document.getElementById("config-area").value = "";
    document.getElementById("dirty-msg").style.display = "none";
    document.getElementById("dirty-score").textContent = "";
    document.getElementById("upload-status").textContent = "";
    document.getElementById("run-status").textContent = "";
    sessionId = null;
}

document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    resetUI();

    const file = document.getElementById("file-input").files[0];
    if (!file) {
        alert("Please select a file");
        return;
    }

    const formData = new FormData();
    formData.append("file", file);

    document.getElementById("upload-status").textContent = "Uploading and analyzing...";

    try {
        const response = await fetch("http://localhost:8000/upload_csv", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Upload failed");
        }

        const data = await response.json();

        sessionId = data.session_id;
        document.getElementById("config-area").value = JSON.stringify(data.config, null, 2);

        if (data.severity !== "INFO") {
            document.getElementById("dirty-msg").style.display = "block";
        }

        document.getElementById("dirty-score").textContent = 
            `Dirty score: ${data.dirty_score}% (${data.severity})`;

        document.getElementById("upload-status").textContent = 
            "Analysis complete. Review / edit config and click 'Run Cleaning'.";

    } catch (err) {
        document.getElementById("upload-status").textContent = 
            "Error: " + (err.message || "Something went wrong");
        console.error(err);
    }
});

document.getElementById("run-btn").addEventListener("click", async () => {
    if (!sessionId) {
        document.getElementById("run-status").textContent = "Please upload a file first.";
        return;
    }

    let config;
    try {
        config = JSON.parse(document.getElementById("config-area").value || "{}");
    } catch (e) {
        document.getElementById("run-status").textContent = "Invalid JSON in config area.";
        return;
    }

    document.getElementById("run-status").textContent = "Cleaning in progress...";

    try {
        const response = await fetch("http://localhost:8000/run_cleaning", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ session_id: sessionId, config })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Cleaning failed");
        }

        const blob = await response.blob();
        const fileName = `${document.getElementById("file-input").files[0].name.split('.')[0]}_cleaned.zip`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        document.getElementById("run-status").textContent = "Cleaning finished. File downloaded.";
        resetUI();

    } catch (err) {
        document.getElementById("run-status").textContent = 
            "Error: " + (err.message || "Failed to clean file");
        console.error(err);
    }
});